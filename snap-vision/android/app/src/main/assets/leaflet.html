<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Leaflet Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <style>
    html, body, #map {
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    .leaflet-popup-content-wrapper {
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script>
    let map;
    let userMarker = null;
    let crowdMarker = null;
    let destinationMarker = null;
    let endCircle = null;
    let startCircle = null;

    // Reported crowd densities and corresponding emoji/icons
    const crowdEmojis = {
      empty: 'ğŸŸ¢ Empty',
      light: 'ğŸŸ¡ Light',
      moderate: 'ğŸŸ  Moderate',
      crowded: 'ğŸ”´ Crowded',
      overcrowded: 'âš« Overcrowded'
    };

    // Handle uncaught errors
    window.onerror = function(message, source, lineno, colno, error) {
      if (window.ReactNativeWebView) {
        window.ReactNativeWebView.postMessage(JSON.stringify({
          type: 'ERROR',
          message,
          source,
          line: lineno,
          column: colno,
          stack: error?.stack
        }));
      }
    };

    function initMap() {
      map = L.map('map', {
        zoomControl: true,
        attributionControl: true,
        preferCanvas: true,
        center: [-25.7557, 28.2314],
        zoom: 14,
      });

      L.tileLayer('https://api.maptiler.com/maps/basic-v2/{z}/{x}/{y}.png?key=xUUmaj1CwbUxWTcxxbmb', {
        attribution: 'Â© OpenStreetMap contributors & MapTiler',
        tileSize: 512,
        zoomOffset: -1,
        detectRetina: true,
        crossOrigin: 'anonymous'
      }).addTo(map);

      // Tell React Native that the map is ready
      setTimeout(() => {
        map.invalidateSize();
        if (window.ReactNativeWebView) {
          window.ReactNativeWebView.postMessage('MAP_READY');
        }
      }, 500);
    }

    // Function to update user location
    window.updateUserLocation = function(lat, lon) {
      const coords = [lat, lon];
      if (!map) return;

      map.setView(coords, 16);

      if (userMarker) {
        userMarker.setLatLng(coords);
      } else {
        userMarker = L.marker(coords)
          .addTo(map)
          .bindPopup("ğŸ“ You are here!")
          .openPopup();
      }
    };

    // Function to show crowd report above the location
    window.updateCrowdDensity = function(lat, lon, density) {
      const coords = [lat, lon];
      if (!map) return;

      const label = crowdEmojis[density] || density;

      if (crowdMarker) {
        crowdMarker.setLatLng(coords).setPopupContent(`ğŸ‘¥ Crowd: ${label}`).openPopup();
      } else {
        crowdMarker = L.marker(coords)
          .addTo(map)
          .bindPopup(`ğŸ‘¥ Crowd: ${label}`)
          .openPopup();
      }
    };

    // Start the map
    try {
      initMap();
    } catch (e) {
      if (window.ReactNativeWebView) {
        window.ReactNativeWebView.postMessage(JSON.stringify({
          type: 'ERROR',
          message: e.message,
          stack: e.stack
        }));
      }
    }

    // Function to clear the destination marker and end circle
    window.clearDestinationMarker = function() {
      if (destinationMarker) {
        map.removeLayer(destinationMarker);
        destinationMarker = null;
      }
      if (endCircle) {
        map.removeLayer(endCircle);
        endCircle = null;
      }
    };

    
    window.drawRoute = function(coords) {
      if (!map || !Array.isArray(coords)) return;
    
      // Remove existing route if already present
      if (window.routeLayer) {
        map.removeLayer(window.routeLayer);
        window.routeLayer = null;
      }
    
      // Remove previous destination marker
      if (destinationMarker) {
        map.removeLayer(destinationMarker);
        destinationMarker = null;
      }
    
      // Remove previous end circle
      if (endCircle) {
        map.removeLayer(endCircle);
        endCircle = null;
      }
    
      // Remove previous start circle
      if (startCircle) {
        map.removeLayer(startCircle);
        startCircle = null;
      }
    
      const latlngs = coords.map(([lon, lat]) => [lat, lon]);
    
      window.routeLayer = L.polyline(latlngs, {
        color: 'blue',
        weight: 6,
        opacity: 1,
        dashArray: '8,6',
      }).addTo(map);
    
      // Add start circle and keep reference
      startCircle = L.circle(latlngs[0], { radius: 5, color: 'green' }).addTo(map);
    
      // Add end circle and keep reference
      endCircle = L.circle(latlngs[latlngs.length - 1], { radius: 5, color: 'red' }).addTo(map);
    
      const bounds = window.routeLayer.getBounds();
      map.fitBounds(bounds.pad(0.3));
    
      // Add start marker
      L.marker(latlngs[0]).addTo(map).bindPopup("ğŸš© Start").openPopup();
    
      // Add end marker and keep reference
      destinationMarker = L.marker(latlngs[latlngs.length - 1]).addTo(map).bindPopup("ğŸ End");
    };
    
    // ...existing code...

  </script>
</body>
</html>